
CREATE TABLE IF NOT EXISTS `stock_total_trades`
WITH (
    'changelog.mode' = 'upsert',
    'kafka.cleanup-policy' = 'compact',
    'kafka.producer.compression.type' = 'zstd',
    'value.fields-include' = 'all'
) AS
SELECT 
    $rowtime AS `trade_timestamp`, 
    `userid`, 
    `side`, 
    `symbol`, 
    SUM(`quantity` * `price`) AS total_price 
FROM 
    `stock_trades` 
GROUP BY 
    $rowtime, 
    `userid`, 
    `side`, 
    `symbol`;